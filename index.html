<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Ø³Ø§Ø² â€” Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</title>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Vazirmatn:wght@700&display=swap');
  :root{--accent:#06b6d4;--bg:#0d0d0d;--panel:#111}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:'Vazirmatn',sans-serif;direction:rtl}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  h1{font-family:'Orbitron',sans-serif;color:var(--accent);font-size:30px;margin:6px 0;text-shadow:0 0 14px rgba(6,182,212,.2),0 0 28px rgba(8,145,178,.08)}
  .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.6);width:360px;max-width:95%}
  textarea{width:100%;height:80px;border-radius:10px;padding:10px;border:none;background:#111;color:#fff;resize:none;font-size:14px;direction:ltr}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
  button[disabled]{opacity:.45;cursor:not-allowed}
  #qr{display:flex;justify-content:center;margin-top:16px;min-height:340px}
  #limitText{color:#ff9b9b;margin-top:8px;font-size:13px}
  .small{font-size:13px;color:#a8b3bd;margin-top:6px}
  #qr canvas{border-radius:8px}
  #loading{display:none;margin-top:16px;color:#9bd3e0;font-size:14px;}
  #countdown{display:none;font-family:'Orbitron',sans-serif;color:#06b6d4;font-size:30px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Rubika.ir/vps_plus</h1>
    <div>
      <textarea id="textInput" placeholder="Ù‡Ø± Ù…ØªÙ† ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³..."></textarea>
      <div class="row">
        <button id="generateBtn">Ø³Ø§Ø®Øª QR</button>
        <button id="downloadBtn" style="display:none" disabled>ğŸ“¥ Ø°Ø®ÛŒØ±Ù‡ PNG</button>
      </div>
      <div id="limitText" class="small"></div>
      <div id="loading">Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª QR... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ â³</div>
      <div id="countdown"></div>
      <div id="qr"></div>
      <div class="small" style="margin-top:10px;color:#9bd3e0">
        Ù…ØªÙ† ÙˆØ³Ø·: <strong style="color:#fff">rdnsparham-rgb.github.io/QR</strong>
      </div>
    </div>
  </div>
</div>

<script>
// Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§
function pad(n){return String(n).padStart(2,'0');}
function todayKey(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}

async function sha256Hex(str){const enc=new TextEncoder().encode(str);const h=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function getCanvasFingerprint(){try{const c=document.createElement('canvas'),ctx=c.getContext('2d');c.width=200;c.height=50;ctx.textBaseline='top';ctx.font='14px Arial';ctx.fillStyle='#f60';ctx.fillRect(125,1,62,20);ctx.fillStyle='#069';ctx.fillText('rdnsparham-fp-test',2,15);ctx.globalCompositeOperation='multiply';ctx.fillStyle='rgb(255,0,255)';ctx.beginPath();ctx.arc(50,20,10,0,Math.PI*2,true);ctx.fill();return c.toDataURL();}catch(e){return 'no-canvas';}}
function collectBrowserString(){const n=navigator;return [n.userAgent||'',n.platform||'',n.language||'',screen.width||0,screen.height||0,screen.colorDepth||0,(Intl?.DateTimeFormat().resolvedOptions().timeZone)||''].join('||');}
async function generateFingerprint(){return sha256Hex(collectBrowserString()+'||'+getCanvasFingerprint());}

function setCookie(name,val,days=365){const d=new Date();d.setTime(d.getTime()+days*24*60*60*1000);document.cookie=`${name}=${encodeURIComponent(val)};expires=${d.toUTCString()};path=/;SameSite=Lax`;}
function getCookie(name){const k=name+'=';return document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(k))?.substring(k.length)||null;}
async function getUsageRecord(fp){const key='qr_limit_'+fp;try{const s=localStorage.getItem(key);if(s)return JSON.parse(s);}catch(e){}const c=getCookie(key);if(c)try{return JSON.parse(decodeURIComponent(c));}catch(e){}return null;}
async function setUsageRecord(fp,rec){const key='qr_limit_'+fp;try{localStorage.setItem(key,JSON.stringify(rec));}catch(e){}try{setCookie(key,JSON.stringify(rec));}catch(e){}}

function waitForCanvas(container,timeout=1500){return new Promise((resolve)=>{const start=Date.now();(function poll(){const canvas=container.querySelector('canvas');if(canvas)return resolve(canvas);if(Date.now()-start>timeout)return resolve(null);setTimeout(poll,50);})();});}

// ----
const MAX_PER_DAY=2;
let qrCode=null;
const qrContainer=document.getElementById('qr');
const generateBtn=document.getElementById('generateBtn');
const downloadBtn=document.getElementById('downloadBtn');
const limitText=document.getElementById('limitText');
const loading=document.getElementById('loading');
const countdownEl=document.getElementById('countdown');

async function init(){const fp=await generateFingerprint();window._fp=fp;const rec=await getUsageRecord(fp);const today=todayKey();if(rec&&rec.date===today){limitText.innerText=`ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²: ${rec.count} Ø§Ø² ${MAX_PER_DAY}`;if(rec.count>=MAX_PER_DAY)disableGenerate();}else{limitText.innerText=`ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²: 0 Ø§Ø² ${MAX_PER_DAY}`;}}
init();

function disableGenerate(){generateBtn.disabled=true;limitText.innerText=`âš ï¸ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ù…Ø±ÙˆØ² Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡ â€” ÙÙ‚Ø· ${MAX_PER_DAY} Ø¨Ø§Ø± Ø¯Ø± Ø±ÙˆØ²`;downloadBtn.style.display='none';downloadBtn.disabled=true;}

function drawCenterLabel(canvas,text){
  const ctx=canvas.getContext('2d');
  const cw=canvas.width,ch=canvas.height;
  ctx.save();
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.font='bold 20px Orbitron, sans-serif';
  ctx.lineWidth=6;
  ctx.strokeStyle='#fff';
  ctx.strokeText(text,cw/2,ch/2);
  ctx.fillStyle='#000';
  ctx.shadowColor='#06b6d4';
  ctx.shadowBlur=10;
  ctx.fillText(text,cw/2,ch/2);
  ctx.restore();
}

generateBtn.addEventListener('click',async()=>{
  const text=document.getElementById('textInput').value.trim();
  if(!text){alert('Ù…ØªÙ† ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');return;}
  const fp=window._fp||await generateFingerprint();
  const today=todayKey();
  let rec=await getUsageRecord(fp);
  if(!rec||rec.date!==today)rec={date:today,count:0};
  if(rec.count>=MAX_PER_DAY){disableGenerate();return;}
  rec.count++;
  await setUsageRecord(fp,rec);
  limitText.innerText=`ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²: ${rec.count} Ø§Ø² ${MAX_PER_DAY}`;
  if(rec.count>=MAX_PER_DAY)disableGenerate();
  qrContainer.style.display='none';
  downloadBtn.style.display='none';
  downloadBtn.disabled=true;
  loading.style.display='block';
  countdownEl.style.display='block';
  generateBtn.disabled=true;

  if(qrCode){qrContainer.innerHTML='';qrCode=null;}

  qrCode=new QRCodeStyling({
    width:320,height:320,type:'canvas',data:text,
    dotsOptions:{color:'#ffffff',type:'rounded'},
    cornersSquareOptions:{color:'#06b6d4',type:'extra-rounded'},
    backgroundOptions:{color:'#0d0d0d'}
  });
  qrCode.append(qrContainer);

  const canvas=await waitForCanvas(qrContainer,1500);
  if(canvas){drawCenterLabel(canvas,'rdnsparham-rgb.github.io/QR');}

  let secs=3;
  countdownEl.innerText=secs;
  const timer=setInterval(()=>{
    secs--;
    countdownEl.innerText=secs>0?secs:'';
    if(secs<=0){
      clearInterval(timer);
      loading.style.display='none';
      countdownEl.style.display='none';
      qrContainer.style.display='flex';
      downloadBtn.style.display='inline-block';
      downloadBtn.disabled=false;
      generateBtn.disabled=false;
    }
  },1000);
});

downloadBtn.addEventListener('click',()=>{
  if(!qrCode){alert('Ø§Ø¨ØªØ¯Ø§ QR Ø¨Ø³Ø§Ø²');return;}
  qrCode.download({name:'QR_Code',extension:'png'});
});
</script>
</body>
</html>
