<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR ساز — محدودیت روزانه</title>

<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Vazirmatn:wght@700&display=swap');
  :root{--accent:#06b6d4;--bg:#0d0d0d;--panel:#111}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:'Vazirmatn',sans-serif;direction:rtl}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  h1{font-family:'Orbitron',sans-serif;color:var(--accent);font-size:30px;margin:6px 0;text-shadow:0 0 14px rgba(6,182,212,.2),0 0 28px rgba(8,145,178,.08)}
  .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.6);width:360px;max-width:95%}
  textarea{width:100%;height:80px;border-radius:10px;padding:10px;border:none;background:#111;color:#fff;resize:none;font-size:14px;direction:ltr}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
  button[disabled]{opacity:.45;cursor:not-allowed}
  #qr{display:flex;justify-content:center;margin-top:16px}
  #limitText{color:#ff9b9b;margin-top:8px;font-size:13px}
  .small{font-size:13px;color:#a8b3bd;margin-top:6px}
  #qr canvas{border-radius:8px}
  #countdown{font-size:28px;color:#06b6d4;text-align:center;margin-top:10px;font-family:'Orbitron',sans-serif;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Rubika.ir/vps_plus</h1>
    <div>
      <textarea id="textInput" placeholder="هر متن یا آدرس را اینجا بنویس..."></textarea>
      <div class="row">
        <button id="generateBtn">ساخت QR</button>
        <button id="downloadBtn" style="display:none">📥 ذخیره PNG</button>
      </div>
      <div id="limitText" class="small"></div>
      <div id="countdown"></div>
      <div id="qr"></div>
      <div class="small" style="margin-top:10px;color:#9bd3e0">متن وسط: <strong style="color:#fff">rdnsparham-rgb.github.io/QR</strong></div>
    </div>
  </div>
</div>

<script>
async function sha256Hex(str){const e=new TextEncoder().encode(str),t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join("")}
function getCanvasFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=200,e.height=50,t.textBaseline="top",t.font="14px 'Arial'",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("rdnsparham-fp-test",2,15),t.globalCompositeOperation="multiply",t.fillStyle="rgb(255,0,255)",t.beginPath(),t.arc(50,20,10,0,2*Math.PI,!0),t.fill(),e.toDataURL()}catch(e){return"no-canvas"}}
function collectBrowserString(){const e=navigator;return[e.userAgent||"",e.platform||"",e.language||"",screen.width,screen.height,screen.colorDepth||"",Intl?.DateTimeFormat().resolvedOptions().timeZone||""].join("||")}
function openDB(){return new Promise((e,t)=>{const n=indexedDB.open("qr_limit_db",1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("limits")||t.createObjectStore("limits",{keyPath:"id"})},n.onsuccess=t=>e(t.target.result),n.onerror=e=>t(e)})}
async function idbGet(e){try{const t=await openDB();return new Promise((n,a)=>{const o=t.transaction("limits","readonly"),r=o.objectStore("limits"),i=r.get(e);i.onsuccess=()=>n(i.result?i.result.value:null),i.onerror=()=>n(null)})}catch(e){return null}}
async function idbSet(e,t){try{const n=await openDB();return new Promise((a,o)=>{const r=n.transaction("limits","readwrite"),i=r.objectStore("limits");i.put({id:e,value:t}),r.oncomplete=()=>a(!0),r.onerror=()=>a(!1)})}catch(e){return!1}}
function setCookie(e,t,n=365){const a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3),document.cookie=`${e}=${t};expires=${a.toUTCString()};path=/;SameSite=Lax`}
function getCookie(e){const t=e+"=",n=document.cookie.split(";");for(let e of n)if(e=e.trim(),0===e.indexOf(t))return e.substring(t.length);return null}
function todayKey(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}
async function generateFingerprint(){const e=getCanvasFingerprint(),t=collectBrowserString(),n=t+"||"+e,a=await sha256Hex(n);return a}
const MAX_PER_DAY=2;async function getUsageRecord(e){const t="qr_limit_"+e;try{const e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch(e){}const n=await idbGet(t);if(n)return n;const a=getCookie(t);if(a)try{return JSON.parse(a)}catch(e){}return null}async function setUsageRecord(e,t){const n="qr_limit_"+e;try{localStorage.setItem(n,JSON.stringify(t))}catch(e){}try{await idbSet(n,t)}catch(e){}try{setCookie(n,JSON.stringify(t),365)}catch(e){}}
const qrContainer=document.getElementById("qr"),generateBtn=document.getElementById("generateBtn"),downloadBtn=document.getElementById("downloadBtn"),limitText=document.getElementById("limitText"),countdownEl=document.getElementById("countdown");let qrCode;
async function init(){const e=await generateFingerprint();window._qr_fp=e;const t=await getUsageRecord(e),n=todayKey();t&&t.date===n?(limitText.innerText=`تعداد استفاده امروز: ${t.count} از ${MAX_PER_DAY}`,t.count>=MAX_PER_DAY&&disableGenerate()):limitText.innerText=`تعداد استفاده امروز: 0 از ${MAX_PER_DAY}`}init();
function disableGenerate(){generateBtn.disabled=!0,generateBtn.style.opacity="0.5",limitText.innerText=`⚠️ محدودیت امروز اعمال شده — فقط ${MAX_PER_DAY} بار در روز`}
generateBtn.addEventListener("click",async()=>{generateBtn.disabled=!0,generateBtn.innerText="در حال ساخت...";try{const e=document.getElementById("textInput").value.trim();if(!e)return alert("متنی وارد کنید"),generateBtn.disabled=!1,generateBtn.innerText="ساخت QR",void 0;const t=window._qr_fp||await generateFingerprint(),n=todayKey();let a=await getUsageRecord(t);(!a||a.date!==n)&&(a={date:n,count:0}),a.count>=MAX_PER_DAY?(disableGenerate(),generateBtn.innerText="ساخت QR"):(
a.count++,await setUsageRecord(t,a),limitText.innerText=`تعداد استفاده امروز: ${a.count} از ${MAX_PER_DAY}`,a.count>=MAX_PER_DAY&&disableGenerate(),
qrContainer.innerHTML="",countdownEl.style.display="block",downloadBtn.style.display="none",
countdownEl.innerText="3",let count=3,
qrCode=new QRCodeStyling({width:320,height:320,type:"canvas",data:e,dotsOptions:{color:"#ffffff",type:"rounded"},cornersSquareOptions:{color:"#06b6d4",type:"extra-rounded"},backgroundOptions:{color:"#0d0d0d"}}),
qrCode.append(qrContainer),
setTimeout(()=>{
const canvas=qrContainer.querySelector("canvas");if(!canvas)return;
const ctx=canvas.getContext("2d"),label="rdnsparham-rgb.github.io/QR";
ctx.font="bold 17px Vazirmatn, sans-serif";ctx.textAlign="center";ctx.textBaseline="middle";
ctx.lineWidth=6;ctx.strokeStyle="#fff";ctx.strokeText(label,canvas.width/2,canvas.height/2);
ctx.fillStyle="#000";ctx.fillText(label,canvas.width/2,canvas.height/2);
ctx.shadowColor="#06b6d4";ctx.shadowBlur=8;
},350),
(()=>{let e=3;const t=setInterval(()=>{e--,countdownEl.innerText=e>0?e:"";0===e&&(clearInterval(t),countdownEl.style.display="none",qrContainer.style.display="flex",downloadBtn.style.display="inline-block")},1e3)})())}catch(e){console.error(e),alert("خطا در ساخت QR — مجدداً تلاش کن.")}finally{generateBtn.disabled=!1,generateBtn.innerText="ساخت QR"}});
downloadBtn.addEventListener("click",async()=>{qrCode?qrCode.download({name:"QR_Code",extension:"png"}):alert("ابتدا QR بساز")});
</script>
</body>
</html>
