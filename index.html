<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR ساز — محدودیت روزانه</title>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Vazirmatn:wght@700&display=swap');
  :root{--accent:#06b6d4;--bg:#0d0d0d;--panel:#111}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:'Vazirmatn',sans-serif;direction:rtl}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
  h1{font-family:'Orbitron',sans-serif;color:var(--accent);font-size:30px;margin:6px 0;text-shadow:0 0 14px rgba(6,182,212,.2),0 0 28px rgba(8,145,178,.08)}
  .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.6);width:360px;max-width:95%}
  textarea{width:100%;height:80px;border-radius:10px;padding:10px;border:none;background:#111;color:#fff;resize:none;font-size:14px;direction:ltr}
  .row{display:flex;gap:8px;align-items:center;margin-top:10px}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
  button[disabled]{opacity:.45;cursor:not-allowed}
  #qr{display:flex;justify-content:center;margin-top:16px}
  #limitText{color:#ff9b9b;margin-top:8px;font-size:13px}
  .small{font-size:13px;color:#a8b3bd;margin-top:6px}
  /* ensure canvas has white outline center text stands out */
  #qr canvas{border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Rubika.ir/vps_plus</h1>
    <div>
      <textarea id="textInput" placeholder="هر متن یا آدرس را اینجا بنویس..."></textarea>
      <div class="row">
        <button id="generateBtn">ساخت QR</button>
        <button id="downloadBtn" style="display:none">📥 ذخیره PNG</button>
      </div>
      <div id="limitText" class="small"></div>
      <div id="qr"></div>
      <div class="small" style="margin-top:10px;color:#9bd3e0">متن وسط: <strong style="color:#fff">Rubika:VPS_Plus</strong></div>
    </div>
  </div>
</div>

<script>
// --- ابزارهای کمکی و محدودیت روزانه همان قبلی ---
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const h = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  return h;
}
function getCanvasFingerprint(){ try{const c=document.createElement('canvas');const ctx=c.getContext('2d');c.width=200;c.height=50;ctx.textBaseline="top";ctx.font="14px 'Arial'";ctx.fillStyle="#f60";ctx.fillRect(125,1,62,20);ctx.fillStyle="#069";ctx.fillText("rdnsparham-fp-test",2,15);ctx.globalCompositeOperation="multiply";ctx.fillStyle="rgb(255,0,255)";ctx.beginPath();ctx.arc(50,20,10,0,Math.PI*2,true);ctx.fill();return c.toDataURL();}catch(e){return "no-canvas";}}
function collectBrowserString(){const nav=navigator;const parts=[nav.userAgent||'',nav.platform||'',nav.language||'',screen.width,screen.height,screen.colorDepth||'',Intl?.DateTimeFormat().resolvedOptions().timeZone || ''];return parts.join('||');}
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open('qr_limit_db',1);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains('limits'))db.createObjectStore('limits',{keyPath:'id'});};r.onsuccess=e=>res(e.target.result);r.onerror=e=>rej(e);});}
async function idbGet(id){try{const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('limits','readonly');const store=tx.objectStore('limits');const rq=store.get(id);rq.onsuccess=()=>res(rq.result?rq.result.value:null);rq.onerror=()=>res(null);});}catch(e){return null;}}
async function idbSet(id,value){try{const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('limits','readwrite');const store=tx.objectStore('limits');store.put({id:id,value:value});tx.oncomplete=()=>res(true);tx.onerror=()=>res(false);});}catch(e){return false;}}
function setCookie(name,value,days=365){const d=new Date();d.setTime(d.getTime()+(days*24*60*60*1000));document.cookie=`${name}=${value};expires=${d.toUTCString()};path=/;SameSite=Lax`;}
function getCookie(name){const k=name+'=';const ca=document.cookie.split(';');for(let c of ca){c=c.trim();if(c.indexOf(k)===0)return c.substring(k.length);}return null;}
function todayKey(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
async function generateFingerprint(){const canvasData=getCanvasFingerprint();const browser=collectBrowserString();const raw=browser+'||'+canvasData;const hash=await sha256Hex(raw);return hash;}
const MAX_PER_DAY=2;
async function getUsageRecord(fp){const key='qr_limit_'+fp;try{const raw=localStorage.getItem(key);if(raw)return JSON.parse(raw);}catch(e){}const idb=await idbGet(key);if(idb)return idb;const ck=getCookie(key);if(ck)try{return JSON.parse(ck);}catch(e){}return null;}
async function setUsageRecord(fp,rec){const key='qr_limit_'+fp;try{localStorage.setItem(key,JSON.stringify(rec));}catch(e){}try{await idbSet(key,rec);}catch(e){}try{setCookie(key,JSON.stringify(rec),365);}catch(e){}}

// --- QR logic & UI ---
let qrCode;
const qrContainer=document.getElementById('qr');
const generateBtn=document.getElementById('generateBtn');
const downloadBtn=document.getElementById('downloadBtn');
const limitText=document.getElementById('limitText');

async function init(){
  const fp=await generateFingerprint();
  window._qr_fp=fp;
  const rec=await getUsageRecord(fp);
  const today=todayKey();
  if(rec && rec.date===today){
    limitText.innerText=`تعداد استفاده امروز: ${rec.count} از ${MAX_PER_DAY}`;
    if(rec.count>=MAX_PER_DAY) disableGenerate();
  }else{
    limitText.innerText=`تعداد استفاده امروز: 0 از ${MAX_PER_DAY}`;
  }
}
init();

function disableGenerate(){generateBtn.disabled=true;generateBtn.style.opacity='0.5';limitText.innerText=`⚠️ محدودیت امروز اعمال شده — فقط ${MAX_PER_DAY} بار در روز`;}

// generate QR
generateBtn.addEventListener('click', async ()=>{
  generateBtn.disabled=true;
  generateBtn.innerText='در حال ساخت...';
  try{
    const text=document.getElementById('textInput').value.trim();
    if(!text){alert('متنی وارد کنید');generateBtn.disabled=false;generateBtn.innerText='ساخت QR';return;}
    const fp=window._qr_fp || await generateFingerprint();
    const today=todayKey();
    let rec=await getUsageRecord(fp);
    if(!rec || rec.date!==today) rec={date:today,count:0};
    if(rec.count>=MAX_PER_DAY){disableGenerate();generateBtn.innerText='ساخت QR';return;}
    rec.count++; await setUsageRecord(fp,rec);
    limitText.innerText=`تعداد استفاده امروز: ${rec.count} از ${MAX_PER_DAY}`;
    if(rec.count>=MAX_PER_DAY) disableGenerate();
    if(qrCode) qrContainer.innerHTML='';
    qrCode=new QRCodeStyling({
      width:320,
      height:320,
      type:'canvas',
      data:text,
      dotsOptions:{color:'#ffffff',type:'rounded'},
      cornersSquareOptions:{color:'#06b6d4',type:'extra-rounded'},
      backgroundOptions:{color:'#0d0d0d'}
    });
    qrCode.append(qrContainer);
    setTimeout(()=>{
      const canvas=qrContainer.querySelector('canvas');
      if(!canvas) return;
      const ctx=canvas.getContext('2d');
      const label='Rubika:VPS_Plus';
      ctx.font="bold 17px Vazirmatn, sans-serif";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.lineWidth=6; ctx.strokeStyle="#fff"; ctx.strokeText(label,canvas.width/2,canvas.height/2);
      ctx.fillStyle="#000"; ctx.fillText(label,canvas.width/2,canvas.height/2);
      ctx.shadowColor="#06b6d4"; ctx.shadowBlur=8;
    },350);
    downloadBtn.style.display='inline-block';
  }catch(e){console.error(e);alert('خطا در ساخت QR — مجدداً تلاش کن.');}finally{generateBtn.disabled=false;generateBtn.innerText='ساخت QR';}
});

// download
downloadBtn.addEventListener('click',async ()=>{if(!qrCode){alert('ابتدا QR بساز');return;} qrCode.download({name:'QR_Code',extension:'png'});});
</script>
</body>
</html>
